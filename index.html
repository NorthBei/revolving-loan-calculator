<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>循環貸計算機 | 呢喃貓-科學貓貓</title>
    <link rel="stylesheet" href="./style/index.css">
    <link rel="icon" href="./public/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  </head>
  <body>
    <main>
      <div class="container-xl">
        <h1>循環貸計算機</h1>
        <!-- <p>所有欄位都支援小數點以下2位的計算，有關幣價的欄位都是以USDT進行計算</p> -->
        <form>
          <div class="row">
            <div class="col-12 col-md-6 col-lg-3">
              <label for="supply-token" class="form-label">存幣的幣價(Supply Token Pricing)</label>
              <div class="input-group mb-2">
                <span class="input-group-text" id="supply-token-prefix">$</span>
                <input type="text" class="form-control" id="supply-token" aria-describedby="supplyToken">
              </div>
              <div id="supply-token-help" class="form-text"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
            </div>
          </div>
          <div class="row">
            <div class="col-12 col-md-6 col-lg-3">
              <label for="supply-token-apy" class="form-label">存幣的年化收益(Supply APY)</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" id="supply-token-apy" aria-describedby="supply-token-apy" value="9.4">
                <span class="input-group-text" id="supply-token-apy-postfix">%</span>
              </div>
              <div id="supply-token-apy-help" class="form-text"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label for="borrow-token-apy" class="form-label">借幣的年化收益(borrow APY)</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" id="borrow-token-apy" aria-describedby="borrow-token-apy" value="2.72">
                <span class="input-group-text" id="borrow-token-apy-postfix">%</span>
              </div>
              <div id="borrow-token-apy-help" class="form-text"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
            </div>
            <div class="col-12 col-md-6 col-lg-3">
            </div>
          </div>
          <div class="row">
            <div class="col-12 col-md-6 col-lg-3">
              <label for="max-ltv" class="form-label">最高/貸款比率(Maximum LTV)</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" id="max-ltv" aria-describedby="borrowTokenApy" value="80">
                <span class="input-group-text" id="max-ltv-postfix">%</span>
              </div>
              <div id="max-ltv-help" class="form-text">最高貸款比率，80%表示US$100等值ETH最多可貸出US$80資產</div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label for="liquidation-threshold" class="form-label">清算門檻(Liquidation threshold)</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" id="liquidation-threshold" aria-describedby="liquidation-threshold">
                <span class="input-group-text" id="liquidation-threshold-postfix">%</span>
              </div>
              <div id="liquidation-threshold-help" class="form-text">如果是82.5%表示當LTV (貸款額除以抵押品金額）超過82.5%時你便會被斬倉，抵押的幣會被賣出償還債務</div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label for="liquidation-penalty" class="form-label">清算罰款(Liquidation penalty)</label>
              <div class="input-group mb-2">
                <input type="text" class="form-control" id="liquidation-penalty" aria-describedby="liquidation-penalty">
                <span class="input-group-text" id="liquidation-penalty-postfix">%</span>
              </div>
              <div id="liquidation-penalty-help" class="form-text">如果是5%，代表當你被斬倉時，巿場會用5%折扣買入你的幣，等於變相有5%罰款</div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
            </div>
          </div>

          <div class="row">
            <div class="col-12 col-md-6 col-lg-3">
              <label for="starting-value" class="form-label">起始資金(Starting Value)</label>
              <div class="input-group mb-2">
                <span class="input-group-text" id="starting-value-prefix">$</span>
                <input type="text" class="form-control" id="starting-value" aria-describedby="starting-value" value="1000">
              </div>
              <div id="starting-value-help" class="form-text"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
              <label for="lending-loops" class="form-label">循環借貸次數(Lending Loops)</label>
              <div class="input-group mb-2">
                <input type="number" class="form-control" id="lending-loops" aria-describedby="lending-loops" value="6">
              </div>
              <div id="lending-loops-help" class="form-text"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 align-self-end">
              <div class="input-group mb-2">
                <button type="button" id="excuteBtn" class="excuteBtn btn btn-primary">執行試算</button>
              </div>
              <div class="form-text"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
            </div>
          </div>
        </form>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="calcResult-tab" data-bs-toggle="tab" data-bs-target="#calcResult" type="button" role="tab"
              aria-controls="calcResult" aria-selected="true">計算結果</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="calcDetail-tab" data-bs-toggle="tab" data-bs-target="#calcDetail" type="button" role="tab"
              aria-controls="calcDetail" aria-selected="false">運算過程</button>
          </li>
        </ul>
        <div class="tab-content" id="myTabContent">
          <div class="tab-pane fade show active" id="calcResult" role="tabpanel" aria-labelledby="calcResult-tab">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Item</th>
                  <th scope="col">Content</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">1</th>
                  <td>總投報率(Overall Interest)</td>
                  <td>
                    <span id="overallInterestValue">0%</span>
                  </td>
                </tr>
                <tr>
                  <th scope="row">2</th>
                  <td>存幣損益(Supply Earnings)</td>
                  <td><span id="supplyEarningsValue">$0</span></td>
                </tr>
                <tr>
                  <th scope="row">3</th>
                  <td>借幣損益(Borrow Earnings)</td>
                  <td>
                    <span id="borrowEarningsValue">$0</span>
                  </td>
                </tr>
                <tr>
                  <th scope="row">4</th>
                  <td>淨收益(Net Earnings)</td>
                  <td><span id="netEarningsValue">$0</span></td>
                </tr>
                <tr>
                  <th scope="row">5</th>
                  <td>總曝險部位</td>
                  <td><span id="totalValue">$0</span></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="tab-pane fade" id="calcDetail" role="tabpanel" aria-labelledby="calcDetail-tab">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th scope="col">輪次</th>
                  <th scope="col">押入金額</th>
                  <th scope="col">得到利息</th>
                  <th scope="col">總部位</th>
                  <th scope="col">該輪增加利息</th>
                  <th scope="col">總利息</th>
                  <th scope="col">增加利息/初始部位</th>
                </tr>
              </thead>
              <tbody class="calcDetailContent">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
      document.getElementsByClassName("excuteBtn")[0].addEventListener("click", dataValidation);

        function dataValidation() {
          // check number + float
          const supplyAPYElement = document.getElementById("supply-token-apy");
          const borrowAPYElement = document.getElementById("borrow-token-apy");
          const maxLTVElement = document.getElementById("max-ltv");
          const loopNumsElement = document.getElementById("lending-loops");
          const startValueElement = document.getElementById("starting-value");

          if( isNumOrFloat(supplyAPYElement.value) === false ){
            supplyAPYElement.style.backgroundColor = "rgba(220, 53, 69, 0.2)";
            return null;
          }else{
            supplyAPYElement.style.backgroundColor = "";
          }

          if( isNumOrFloat(borrowAPYElement.value) === false ){
             borrowAPYElement.style.backgroundColor = "rgba(220, 53, 69, 0.2)";
             return null;
          }else{
            borrowAPYElement.style.backgroundColor = "";
          }
          
          if( isNumOrFloat(maxLTVElement.value) === false ){
            maxLTVElement.style.backgroundColor = "rgba(220, 53, 69, 0.2)";
            return null;
          }else{
            maxLTVElement.style.backgroundColor = "";
          }

          if( isNumOrFloat(loopNumsElement.value) === false ){
            loopNumsElement.style.backgroundColor = "rgba(220, 53, 69, 0.2)";
            return null;
          }else{
            loopNumsElement.style.backgroundColor = "";
          }
          
          if( isNumOrFloat(startValueElement.value) === false ){
            startValueElement.style.backgroundColor = "rgba(220, 53, 69, 0.2)";
            return null;
          }else{
            startValueElement.style.backgroundColor = "";
          }

          excutRevolvingLoan();
        }

        function isNumOrFloat(inputValue) {
          return inputValue.match(/^-?\d*(\.\d+)?$/) === null ? false : true;
        }

        function excutRevolvingLoan() {
          // 存幣的年化收益(Supply APY)
          const supplyAPY = document.getElementById("supply-token-apy").value /100;
          // 借幣的年化利息(borrow APY)
          const borrowAPY = document.getElementById("borrow-token-apy").value /100;
          // 最高貸款比率(Maximum LTV)
          const maxLTV = document.getElementById("max-ltv").value /100;
          // 起始資金(Starting Value)
          const startValue = parseInt(document.getElementById("starting-value").value);
          // 循環借貸次數(Lending Loops)
          const loopNums = document.getElementById("lending-loops").value;

          // 每次拿多少部位去押
          let theRoundValue = 0;
          // 每次貸款取得的利息
          let yieldValue = 0;
          // 循環貸後，全部的利息
          let totalYieldValue = 0;
          // 循環貸後的APY
          let totalAPY = 0;
          // 循環貸後的部位
          let totalValue = 0;
          //
          let supplyEarning = 0
          //
          let brrowEarning = 0;

          for (let y = 0; y < loopNums; y++) {
            let theRoundSupplyEarning = 0;
            let theRoundBrrowEarning = 0;
            theRoundValue = startValue * maxLTV ** (y);
            totalValue += theRoundValue;
            if( y === 0 ) {
              // 一開始本金是自己的，不是借的，所以不用支付借款利息
              yieldValue = theRoundValue * supplyAPY;
              theRoundSupplyEarning = theRoundValue * supplyAPY;
            }else{
              theRoundSupplyEarning = theRoundValue * supplyAPY;
              theRoundBrrowEarning = theRoundValue * borrowAPY;
              yieldValue = theRoundValue * (supplyAPY - borrowAPY);
            }

            supplyEarning += theRoundSupplyEarning;
            brrowEarning += theRoundBrrowEarning;

            totalYieldValue = totalYieldValue + yieldValue;
            console.log(`第 ${y} 輪, 拿 ${theRoundValue.toFixed(2)} 去押, 得到的利息為： ${yieldValue.toFixed(2)} , 目前總部位為： ${totalValue.toFixed(2)}, 總利息為：${totalYieldValue.toFixed(2)}`);

            const tbodyRef = document.getElementsByClassName("calcDetailContent")[0];
            let newTr = document.createElement("tr");
            let newTh = document.createElement("th");
            let newTd1 = document.createElement("td");
            let newTd2 = document.createElement("td");
            let newTd3 = document.createElement("td");
            let newTd4 = document.createElement("td");
            let newTd5 = document.createElement("td");
            newTh.innerHTML = `第 ${y+1} 輪`;
            newTr.appendChild(newTh);
            newTd1.innerHTML = `拿 ${theRoundValue.toFixed(2)} 去押`;
            newTr.appendChild(newTd1);
            newTd2.innerHTML = `得到的利息為： ${yieldValue.toFixed(2)}`;
            newTr.appendChild(newTd2);
            newTd3.innerHTML = `目前總部位為： ${totalValue.toFixed(2)}`;
            newTr.appendChild(newTd3);
            newTd4.innerHTML = `總利息為：${totalYieldValue.toFixed(2)}`;
            newTr.appendChild(newTd4);
            newTd5.innerHTML = `${(yieldValue / startValue).toFixed(4) * 100} %`;
            newTr.appendChild(newTd5);
            tbodyRef.appendChild(newTr);
          }
          totalAPY =  supplyAPY * totalYieldValue / (startValue * supplyAPY) * 100;

          document.getElementById("overallInterestValue").textContent = totalAPY.toFixed(2) + '%';
          document.getElementById("supplyEarningsValue").textContent = '$' + supplyEarning.toFixed(2);
          document.getElementById("borrowEarningsValue").textContent = '-$' + brrowEarning.toFixed(2);
          document.getElementById("netEarningsValue").textContent = '$' + totalYieldValue.toFixed(2);
          document.getElementById("totalValue").textContent = '$' + totalValue.toFixed(2);
        }
    </script>
  </body>
</html>